AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: deno_registry2

Resources:
  Deno:
    Type: AWS::Serverless::Application
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:us-east-1:390065572566:applications/deno
        SemanticVersion: 1.2.0

  WebhookGithubFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: .
      MemorySize: 512
      Handler: bundle.handler
      Runtime: provided
      Layers:
        - !GetAtt Deno.Outputs.LayerArn
        - arn:aws:lambda:us-east-2:553035198032:layer:git-lambda2:6
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ModuleEntriesTable
        - S3CrudPolicy:
            BucketName: !Ref StorageBucket
      Environment:
        Variables:
          DENO_UNSTABLE: 1
          HANDLER_EXT: js
          MODULE_ENTRIES_TABLE: !Ref ModuleEntriesTable
          STORAGE_BUCKET: !Ref StorageBucket
      Timeout: 60
      Events:
        ApiEvent:
          Type: HttpApi
          Properties:
            Path: /webhook/gh/{name}
            Method: POST
    Metadata:
      BuildMethod: makefile

  ModuleEntriesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: name
          AttributeType: S
        - AttributeName: star_count
          AttributeType: "N"
      KeySchema:
        - AttributeName: name
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: by_star_count
          KeySchema:
            - AttributeName: name
              KeyType: HASH
            - AttributeName: star_count
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  StorageBucket:
    Type: AWS::S3::Bucket
    Properties:
      CorsConfiguration:
        CorsRules:
          - AllowedMethods: [GET]
            AllowedOrigins: ["*"]

Outputs:
  ApiEndpoint:
    Value: !Sub "https://${ServerlessHttpApi}.execute-api.${AWS::Region}.amazonaws.com/"
  S3Bucket:
    Value: !Sub "${StorageBucket}.s3.${AWS::Region}.amazonaws.com"
